<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    .container {
        height: 90%; /* 使用百分比来设置宽度 */
        max-height: 1400px; /* 设置最大宽度 */
        width: 70%; /* 使用百分比来设置宽度 */
        max-width: 2100px; /* 设置最大宽度 */
        background-color: #000000;
        margin: 0 auto; /* 居中显示 */
        padding: 20px;
    }

    header {
        height: 4%;
        background-color: #eca5a5;
    }
    nav {
        height: 4%;
        background-color: #b9f3b3;

        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 20px;
    }
    nav button {
        padding: 12px 24px;
        background-color: #ccc;
        /* border: none; */
        border-radius: 4px;
        color: #fff;
        font-size: 20px;
    }

    main {
        height: 90%;
        background-color: #c8a3e0;
        /* margin-top: -20px; */

        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 20px;
    }
    .nav-bar {
        width: 30%;
        height: 100%;
        background-color: #70b6e8;
    }

    .guide-collapse {
        display: none;
        background-color: #ccc;
        margin-top: 20px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
    }
    .guide-collapsed-content {
        display: none;
        margin-top: 10px;
    }
    .devmonitor-collapse-PCS {
        display: none;
        background-color: #ccc;
        margin-top: 20px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
    }
    .devmonitor-collapsed-PCS-content {
        display: none;
        margin-top: 10px;
    }

    .content {
        width: 70%;
        height: 100%;
        background-color: #d2e896;
    }

    .param-form {
        display: none;
    }

    .device-table {
        display: none;
    }

    .channel-table {
      display: none;
    }

    .device-activity-table {
        display: none;
    }

    #popupForm {
      display: none;

      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px;
    }

    #popupForm input {
      display: block;
      margin-bottom: 10px;
    }

    #channel-form {
      display: none;

      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px;
    }

    footer {
        height: 1%;
        background-color: #a1a0ee;
        clear: both;
    }
  </style>
  <script>
    // ui交互逻辑
    window.addEventListener('DOMContentLoaded', function() {
      const btnGuide = document.querySelector('#guide-btn');
      const collapseGuide = document.querySelector('.guide-collapse');
      const collapsedContentGuide = document.querySelector('.guide-collapsed-content');
      
      const paramForm = document.querySelector('.param-form');
      const deviceTable = document.querySelector('.device-table');
      const channelTable = document.querySelector('.channel-table');
      
      // 导航表格显示
      btnGuide.addEventListener('click', function() {
        paramForm.style.display = 'none';
        deviceTable.style.display = 'none';
        channelTable.style.display = 'none';
        deviceActivityTable.style.display = 'none';

        collapseGuide.style.display = 'block';
        PCScollapseDevMonitor.style.display = 'none';
      });
      collapseGuide.addEventListener('click', function() {
        collapsedContentGuide.style.display = 'block';
      });

      // 开始向导->基础参数
      const baseParam = document.querySelector('.base_param');
      baseParam.addEventListener('click', function() {
        paramForm.style.display = 'block';
        deviceTable.style.display = 'none';
        channelTable.style.display = 'none';
      });
      // 开始向导->设备管理
      const deviceMamage = document.querySelector('.device_mamage');
      deviceMamage.addEventListener('click', function() {
        paramForm.style.display = 'none';
        deviceTable.style.display = 'block';
        channelTable.style.display = 'none';
      });
      // 开始向导->通道管理
      const channelMamage = document.querySelector('.channel_mamage');
      channelMamage.addEventListener('click', function() {
        paramForm.style.display = 'none';
        deviceTable.style.display = 'none';
        channelTable.style.display = 'block';
      });
      

      const btnDevMonitor = document.querySelector('#devmonitor-btn');
      const PCScollapseDevMonitor = document.querySelector('.devmonitor-collapse-PCS');
      const PCScollapsedContentDevMonitor = document.querySelector('.devmonitor-collapsed-PCS-content');

      const deviceActivityTable = document.querySelector('.device-activity-table');

      // 设备监控表格显示
      btnDevMonitor.addEventListener('click', function() {
        paramForm.style.display = 'none';
        deviceTable.style.display = 'none';
        channelTable.style.display = 'none';
        deviceActivityTable.style.display = 'none';

        collapseGuide.style.display = 'none';
        PCScollapseDevMonitor.style.display = 'block';
      });
      PCScollapseDevMonitor.addEventListener('click', function() {
        PCScollapsedContentDevMonitor.style.display = 'block';
      });
      PCScollapsedContentDevMonitor.addEventListener('click', function() {
        deviceActivityTable.style.display = 'block';
      });
    });

    // 定义设备表格和通道表格的数据获取URL
    const Url = "http://192.168.1.136:9000/api";
    // 页面加载完成时请求数据并填充表格
    window.onload = function() {
      var requestData_getDevTable = {
        taskID: 3,
        taskName: "getDevTable",
        responseTime: 1
      };
      // 请求设备表格的数据
      fetch(Url, {
        method: "POST",
        body: JSON.stringify(requestData_getDevTable)
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        console.log("getDevTable:", data.data);  // 打印解析后的响应数据
        const parsedData = JSON.parse(data.data);
        fillDeviceTable(parsedData.data.table);
      })
      .catch(error => {
        // 处理请求错误
        console.log("请求失败:", error);
      });

      var requestData_getChannelTable = {
        taskID: 4,
        taskName: "getChannelTable",
        responseTime: 1
      };
      // 请求通道表格的数据
      fetch(Url, {
        method: "POST",
        body: JSON.stringify(requestData_getChannelTable)
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        console.log("getChannelTable:", data.data);  // 打印解析后的响应数据
        const parsedData = JSON.parse(data.data);
        fillChannelTable(parsedData.data.table)
      })
      .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
      });
    }
    // 填充设备表格
    function fillDeviceTable(tableData) {
      const deviceList = document.getElementById('deviceList');
      deviceList.innerHTML = ''; // 清空现有数据

      tableData.forEach((row, index) => {
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
              <td><input type="checkbox"></td>
              <td>${index + 1}</td>
              <td>${row.name}</td>
              <td>${row.port}</td>
              <td>${row.protocol}</td>
              <td>${row.communicationAddress}</td>
              <td>${row.category}</td>
              <td>${row.model}</td>
              <td>${row.sn}</td>
              <td>${row.deviceStatus}</td>
          `;

          deviceList.appendChild(tr);

          // 添加数据到外部数组devices
          devices.push(row);

          // 添加DevName到DevNameList
          if (!PCSdevNameList.includes(row.name)) {
              PCSdevNameList.push(row.name);
              updateDevName(PCSdevNameList);  // 3. 更新另一个表的选项
          }
      });
    }
    // 填充通道表格
    function fillChannelTable(tableData) {
      const channelList = document.getElementById('channelList');
      channelList.innerHTML = ''; // 清空现有数据

      tableData.forEach((row, index) => {
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
              <td><input type="checkbox"></td>
              <td>${index + 1}</td>
              <td>${row.portName}</td>
              <td>${row.port}</td>
              <td>${row.baudRate}</td>
              <td>${row.dataBits}</td>
              <td>${row.stopBits}</td>
              <td>${row.parity}</td>
          `;

          channelList.appendChild(tr);

          // 添加portName到portNameList
          if (!portNameList.includes(row.portName)) {
              portNameList.push(row.portName);
              updateChannelName(portNameList);  // 3. 更新另一个表的选项
          }
      });
    }

    // 设备增删改查表单逻辑
    let PCSdevNameList = [];  // 定义外部全局列表
    let devices = [];
    window.addEventListener('DOMContentLoaded', function() {
      const addBtn = document.getElementById("addBtn");
      const deleteBtn = document.getElementById("deleteBtn");
      const editBtn = document.getElementById("editBtn");
      const selectAllCheckbox = document.getElementById("selectAll");
      
      const deviceList = document.getElementById("deviceList");
      const popupForm = document.getElementById("popupForm");
      const deviceNameInput = document.getElementById("deviceName");
      const channelSelect = document.getElementById("channel");
      const protocolSelect = document.getElementById("protocol");
      const communicationAddressInput = document.getElementById("communicationAddress");
      const categorySelect = document.getElementById("category");
      const modelInput = document.getElementById("model");
      const snInput = document.getElementById("sn");
      const deviceStatusInput = document.getElementById("deviceStatus");
      const saveBtn = document.getElementById("saveBtn");
      const cancelBtn = document.getElementById("cancelBtn");

      addBtn.addEventListener("click", function() {
        clearFormInputs();
        showPopupForm();
      });

      deleteBtn.addEventListener("click", function() {
        const checkboxes = deviceList.querySelectorAll('input[type="checkbox"]:checked');

        let delList = [];

        checkboxes.forEach(function(checkbox) {
          const row = checkbox.parentNode.parentNode;
          const index = row.rowIndex - 1;

          // 获取每一行的值，这可能需要你根据实际的HTML结构进行修改
          let currentDevtName = row.children[2].textContent;

          delList.push(row);

          devices.splice(index, 1);
          row.remove();

          // 从PCSdevNameList中删除对应的DevtName
          const devtNameIndex = PCSdevNameList.indexOf(currentDevtName);
          if (devtNameIndex > -1) {
              PCSdevNameList.splice(devtNameIndex, 1);
          }
        });

        selectAllCheckbox.checked = false;

        sendDelJson(delList);

        updateDevName(PCSdevNameList);  // 更新另一个表的选项
      });

      editBtn.addEventListener("click", function() {
        const checkboxes = deviceList.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length !== 1) {
          alert("请选择一个设备进行编辑");
          return;
        }
        const row = checkboxes[0].parentNode.parentNode;
        const index = row.rowIndex - 1;
        const device = devices[index];
        fillFormInputs(device);
        showPopupForm();
      });

      selectAllCheckbox.addEventListener("change", function() {
        const checkboxes = deviceList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(checkbox) {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });

      saveBtn.addEventListener("click", function() {
        const name = deviceNameInput.value.trim();
        const port = channelSelect.value.trim();
        const protocol = protocolSelect.value.trim();
        const communicationAddress = communicationAddressInput.value.trim();
        const category = categorySelect.value.trim();
        const model = modelInput.value.trim();
        const sn = snInput.value.trim();
        const deviceStatus = deviceStatusInput.value.trim();

        // 获取DevtName值
        let currentDevtName = document.getElementById('deviceName').value;

        if (name === "" || communicationAddress === "" || sn === "" || deviceStatus === "") {
          alert("请填写完整设备信息");
          return;
        }

        const newDevice = {
          name: name,
          port: port,
          protocol: protocol,
          communicationAddress: communicationAddress,
          category: category,
          model: model,
          sn: sn,
          deviceStatus: deviceStatus
        };

        const checkboxes = deviceList.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 1) {
          // 编辑模式
          const row = checkboxes[0].parentNode.parentNode;
          const index = row.rowIndex - 1;

          const oldDevice = devices[index];

          devices[index] = newDevice;
          updateTableRow(row, newDevice);

          sendEditJson(newDevice, oldDevice);
        } else {
          // 新增模式
          devices.push(newDevice);
          const newRow = generateTableRow(newDevice);
          deviceList.appendChild(newRow);

          // 添加DevName到DevNameList
          if (!PCSdevNameList.includes(currentDevtName)) {
              PCSdevNameList.push(currentDevtName);
              updateDevName(PCSdevNameList);  // 3. 更新另一个表的选项
          }

          sendSaveJson(newDevice);
        }

        clearFormInputs();
        hidePopupForm();
      });

      cancelBtn.addEventListener("click", function() {
        clearFormInputs();
        hidePopupForm();
      });

      function generateTableRow(device) {
        const row = document.createElement("tr");
        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkboxCell.appendChild(checkbox);

        const indexCell = document.createElement("td");
        indexCell.textContent = devices.length;

        const nameCell = document.createElement("td");
        nameCell.textContent = device.name;

        const portCell = document.createElement("td");
        portCell.textContent = device.port;

        const protocolCell = document.createElement("td");
        protocolCell.textContent = device.protocol;

        const communicationAddressCell = document.createElement("td");
        communicationAddressCell.textContent = device.communicationAddress;

        const categoryCell = document.createElement("td");
        categoryCell.textContent = device.category;

        const modelCell = document.createElement("td");
        modelCell.textContent = device.model;

        const snCell = document.createElement("td");
        snCell.textContent = device.sn;

        const deviceStatusCell = document.createElement("td");
        deviceStatusCell.textContent = device.deviceStatus;

        row.appendChild(checkboxCell);
        row.appendChild(indexCell);
        row.appendChild(nameCell);
        row.appendChild(portCell);
        row.appendChild(protocolCell);
        row.appendChild(communicationAddressCell);
        row.appendChild(categoryCell);
        row.appendChild(modelCell);
        row.appendChild(snCell);
        row.appendChild(deviceStatusCell);

        return row;
      }

      function updateTableRow(row, device) {
        const cells = row.cells;
        cells[2].textContent = device.name;
        cells[3].textContent = device.port;
        cells[4].textContent = device.protocol;
        cells[5].textContent = device.communicationAddress;
        cells[6].textContent = device.category;
        cells[7].textContent = device.model;
        cells[8].textContent = device.sn;
        cells[9].textContent = device.deviceStatus;
      }

      function fillFormInputs(device) {
        deviceNameInput.value = device.name;
        channelSelect.value = device.channel;
        protocolSelect.value = device.protocol;
        communicationAddressInput.value = device.communicationAddress;
        categorySelect.value = device.category;
        modelInput.value = device.model;
        snInput.value = device.sn;
        deviceStatusInput.value = device.deviceStatus;
      }

      function clearFormInputs() {
        deviceNameInput.value = "";
        // channelSelect.value = "";
        communicationAddressInput.value = "";
        modelInput.value = "";
        snInput.value = "";
        deviceStatusInput.value = "";
      }

      function showPopupForm() {
        popupForm.style.display = "block";
      }

      function hidePopupForm() {
        popupForm.style.display = "none";
      }

      function sendJsonToServer() {
        let data = [];
        devices.forEach(function(device) {
          let rowData = {
              name: device.name,
              port: device.port,
              protocol: device.protocol,
              communicationAddress: device.communicationAddress,
              category: device.category,
              model: device.model,
              sn: device.sn,
              deviceStatus: device.deviceStatus
          };
          data.push(rowData);
        });

        var requestData = {
            taskID: 1,
            taskName: "DevTableSave",
            responseTime: 1,
            data: {
              "table" : data
            }
        };

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      function sendSaveJson(device) {
        let rowData = {
            name: device.name,
            port: device.port,
            protocol: device.protocol,
            communicationAddress: device.communicationAddress,
            category: device.category,
            model: device.model,
            sn: device.sn,
            deviceStatus: device.deviceStatus
        };

        var requestData = {
            taskID: 5,
            taskName: "DevSave",
            responseTime: 1,
            data: rowData
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      function sendEditJson(device, oldDevice) {
        let rowData = {
            name: device.name,
            port: device.port,
            protocol: device.protocol,
            communicationAddress: device.communicationAddress,
            category: device.category,
            model: device.model,
            sn: device.sn,
            deviceStatus: device.deviceStatus
        };

        let oldRowData = {
            name: oldDevice.name,
            port: oldDevice.port,
            protocol: oldDevice.protocol,
            communicationAddress: oldDevice.communicationAddress,
            category: oldDevice.category,
            model: oldDevice.model,
            sn: oldDevice.sn,
            deviceStatus: oldDevice.deviceStatus
        };

        var requestData = {
            taskID: 6,
            taskName: "DevEdit",
            responseTime: 1,
            data: {
              "newdata" : rowData,
              "olddata" : oldRowData
            }
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      function sendDelJson(delList) {
        let data = [];
        delList.forEach(function(row) {
            let rowData = {
                name: row.children[2].textContent, // 根据你的表格结构修改索引
                port: row.children[3].textContent,
                protocol: row.children[4].textContent,
                communicationAddress: row.children[5].textContent,
                category: row.children[6].textContent,
                model: row.children[7].textContent,
                sn: row.children[8].textContent,
                deviceStatus: row.children[9].textContent
            };
            data.push(rowData);
        });

        var requestData = {
            taskID: 7,
            taskName: "DevDel",
            responseTime: 1,
            data: {
              "table" : data
            }
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      // 初始化表格数据，可以从后端获取数据进行填充
      devices = [];

      devices.forEach(function(device) {
        const row = generateTableRow(device);
        deviceList.appendChild(row);
      });
    });
    // 创建一个函数来更新另一个表的选项D
    function updateDevName(optionsList) {
      let otherTableContent = document.getElementById('devmonitor-collapsed-PCS-content');

      while (otherTableContent.firstChild) {
        otherTableContent.removeChild(otherTableContent.firstChild);
      }

      optionsList.forEach(optionValue => {
        let liElem = document.createElement('li');
        liElem.textContent = optionValue;

        // 为每个li元素添加点击事件监听器
        liElem.addEventListener('click', function(event) {
          // 单点设备发送http请求，后端收到请求后，通过websocket返回实时数据
          console.log('Clicked:', event.target.textContent);

          var requestData = {
              taskName: "getRTData",
              responseTime: 3,
              data: {
                "isOn" : 1,
                "dev_sn" : event.target.textContent,
                "RTtaskId" : "Yc"
              }
          };

          fetch(Url, {
              method: 'POST',
              // headers: {
              //     'Content-Type': 'application/json'
              // },
              body: JSON.stringify(requestData)
          })
          .then(response => {
              // 处理响应结果
              if (response.ok) {
                  alert("采集数据上传成功！");
              } else {
                  // 登录失败或重置失败，弹出提示
                  alert("采集数据上传失败！");
              }
          })
          .catch(error => {
              // 处理请求错误
              console.log("请求失败:", error);
          });
        });

        otherTableContent.appendChild(liElem);
      });
    }

    // 通道增删改查表单逻辑Channel
    let portNameList = [];  // 定义外部全局列表
    window.addEventListener('DOMContentLoaded', function() {
      const addBtn = document.getElementById('channel-addBtn');
      const deleteBtn = document.getElementById('channel-deleteBtn');
      const editBtn = document.getElementById('channel-editBtn');
      const saveBtn = document.getElementById('channel-saveBtn');
      const cancelBtn = document.getElementById('channel-cancelBtn');
      const form = document.getElementById('channel-form');
      const tableBody = document.getElementById('channelList');
      const selectAllCheckbox = document.getElementById("channel-selectAll");
      let editingRowIndex = null;

      addBtn.addEventListener('click', function() {
          editingRowIndex = null;
          // form.reset();
          form.style.display = 'block';
      });

      deleteBtn.addEventListener('click', function() {
          const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]:checked');
          let deletedParams = [];

          checkboxes.forEach(checkbox => {
            const row = checkbox.parentNode.parentNode;

            // 获取每一行的值，这可能需要你根据实际的HTML结构进行修改
            let currentPortName = row.children[2].textContent;

            tableBody.removeChild(checkbox.closest('tr'));
        
            // 添加被删除的参数到数组中
            deletedParams.push(row);

            // 从portNameList中删除对应的
            const PortNameIndex = portNameList.indexOf(currentPortName);
            if (PortNameIndex > -1) {
              portNameList.splice(PortNameIndex, 1);
            }
          });

          sendDelJson(deletedParams);

          updateChannelName(portNameList);  // 更新另一个表的选项
      });

      editBtn.addEventListener('click', function() {
          const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]:checked');
          if (checkboxes.length === 1) {
              const row = checkboxes[0].closest('tr');
              editingRowIndex = Array.from(tableBody.children).indexOf(row);
              document.getElementById('portName').value = row.cells[2].textContent;
              document.getElementById('port').value = row.cells[3].textContent;
              document.getElementById('baudRate').value = row.cells[4].textContent;
              document.getElementById('dataBits').value = row.cells[5].textContent;
              document.getElementById('stopBits').value = row.cells[6].textContent;
              document.getElementById('parity').value = row.cells[7].textContent;
              form.style.display = 'block';
          }
      });

      selectAllCheckbox.addEventListener("change", function() {
        const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(checkbox) {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });

      saveBtn.addEventListener('click', function(e) {
          e.preventDefault();

          // 获取portName值
          let currentPortName = document.getElementById('portName').value;

          if (editingRowIndex !== null) {
              const oldRow = tableBody.children[editingRowIndex].cloneNode(true);;
              const row = tableBody.children[editingRowIndex];
              row.cells[2].textContent = document.getElementById('portName').value;
              row.cells[3].textContent = document.getElementById('port').value;
              row.cells[4].textContent = document.getElementById('baudRate').value;
              row.cells[5].textContent = document.getElementById('dataBits').value;
              row.cells[6].textContent = document.getElementById('stopBits').value;
              row.cells[7].textContent = document.getElementById('parity').value;

              sendEditJson(row, oldRow);
          } else {
              const newRow = tableBody.insertRow();
              newRow.innerHTML = `
                  <td><input type="checkbox"></td>
                  <td>${tableBody.children.length}</td>
                  <td>${document.getElementById('portName').value}</td>
                  <td>${document.getElementById('port').value}</td>
                  <td>${document.getElementById('baudRate').value}</td>
                  <td>${document.getElementById('dataBits').value}</td>
                  <td>${document.getElementById('stopBits').value}</td>
                  <td>${document.getElementById('parity').value}</td>
              `;

              // 添加portName到portNameList
              if (!portNameList.includes(currentPortName)) {
                  portNameList.push(currentPortName);
                  updateChannelName(portNameList);  // 3. 更新另一个表的选项
              }

              sendSaveJson(newRow);
          }

          form.style.display = 'none';
      });

      cancelBtn.addEventListener('click', function() {
          form.style.display = 'none';
      });

      function sendJsonToServer() {
        let data = [];

        // 获取表格中的所有行数据
        const tableRows = tableBody.getElementsByTagName("tr");
        for (let i = 0; i < tableRows.length; i++) {
          const row = tableRows[i];
          const rowData = {
            // checkbox: row.cells[0].querySelector("input[type='checkbox']").checked,
            // index: row.cells[1].textContent,
            portName: row.cells[2].textContent,
            port: row.cells[3].textContent,
            baudRate: row.cells[4].textContent,
            dataBits: row.cells[5].textContent,
            stopBits: row.cells[6].textContent,
            parity: row.cells[7].textContent
          };
          data.push(rowData);
        }

        var requestData = {
          taskID: 2,
          taskName: "ChannelTableSave",
          responseTime: 1,
          data: {
            table: data
          }
        };

        fetch(Url, {
          method: "POST",
          body: JSON.stringify(requestData)
        })
          .then(response => {
            // 处理响应结果
            if (response.ok) {
              alert("保存成功！");
            } else {
              alert("保存失败！");
            }
          })
          .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
          });
      }

      function sendSaveJson(row) {
        let rowData = {
            portName: row.cells[2].textContent,
            port: row.cells[3].textContent,
            baudRate: row.cells[4].textContent,
            dataBits: row.cells[5].textContent,
            stopBits: row.cells[6].textContent,
            parity: row.cells[7].textContent
        };

        var requestData = {
            taskID: 8,
            taskName: "channelSave",
            responseTime: 1,
            data: rowData
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      function sendEditJson(row, oldRow) {
        let rowData = {
            portName: row.cells[2].textContent,
            port: row.cells[3].textContent,
            baudRate: row.cells[4].textContent,
            dataBits: row.cells[5].textContent,
            stopBits: row.cells[6].textContent,
            parity: row.cells[7].textContent
        };

        let oldRowData = {
            portName: oldRow.cells[2].textContent,
            port: oldRow.cells[3].textContent,
            baudRate: oldRow.cells[4].textContent,
            dataBits: oldRow.cells[5].textContent,
            stopBits: oldRow.cells[6].textContent,
            parity: oldRow.cells[7].textContent
        };

        var requestData = {
            taskID: 9,
            taskName: "ChannelEdit",
            responseTime: 1,
            data: {
              "newdata" : rowData,
              "olddata" : oldRowData
            }
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }

      function sendDelJson(delList) {
        let data = [];
        delList.forEach(function(row) {
            let rowData = {
              portName: row.children[2].textContent,
              port: row.children[3].textContent,
              baudRate: row.children[4].textContent,
              dataBits: row.children[5].textContent,
              stopBits: row.children[6].textContent,
              parity: row.children[7].textContent
            };
            data.push(rowData);
        });

        var requestData = {
            taskID: 10,
            taskName: "ChannelDel",
            responseTime: 1,
            data: {
              "table" : data
            }
        };

        console.log(requestData);

        fetch(Url, {
            method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            // 处理响应结果
            if (response.ok) {
                alert("保存成功！");
            } else {
                // 登录失败或重置失败，弹出提示
                alert("保存失败！");
            }
        })
        .catch(error => {
            // 处理请求错误
            console.log("请求失败:", error);
        });
      }
    });
    // 创建一个函数来更新另一个表的选项
    function updateChannelName(optionsList) {
      let otherTableSelect = document.getElementById('channel');

      while (otherTableSelect.firstChild) {
          otherTableSelect.removeChild(otherTableSelect.firstChild);
      }

      optionsList.forEach(optionValue => {
          let optionElem = document.createElement('option');
          optionElem.value = optionValue;
          optionElem.textContent = optionValue;
          otherTableSelect.appendChild(optionElem);
      });
    }

  </script>
</head>
<body>
  <div class="container">
    <header></header>
    <nav>
      <ul>
        <button id="guide-btn">开始向导</button>
        <button>概览</button>
        <button id="devmonitor-btn">设备监控</button>
        <button>历史查询</button>
        <button>设置</button>
        <button>维护</button>
      </ul>
    </nav>
    <main>
      <div class="nav-bar">
          <!-- 开始向导 -->
          <div class="guide-collapse">
            开始向导
            <div class="guide-collapsed-content">
              <div class="base_param"> <li> 基本参数<br> </li> </div>
              <div class="channel_mamage"> <li> 通道管理 </li> </div>
              <div class="device_mamage"> <li> 设备管理 </li> </div>
            </div>
          </div>

          <!-- 设备监控 -->
          <div class="devmonitor-collapse-PCS">
            PCS
            <div class="devmonitor-collapsed-PCS-content" id="devmonitor-collapsed-PCS-content">
              <!-- 动态显示设备名 -->
            </div>
          </div>
      </div>
      <div class="content">
          <!-- 主窗口显示 -->
          <div class="param-form" id="param-form">
            <form id="ipConfigForm">
              <label for="ipAddress">IP地址 </label>
              <input type="text" id="ipAddress" name="ipAddress"><br><br>
          
              <label for="subnetMask">子网掩码 </label>
              <input type="text" id="subnetMask" name="subnetMask"><br><br>
          
              <label for="defaultGateway">默认网关 </label>
              <input type="text" id="defaultGateway" name="defaultGateway"><br><br>
          
              <label for="primaryDns">首选dns </label>
              <input type="text" id="primaryDns" name="primaryDns"><br><br>
          
              <label for="secondaryDns">备用dns</label>
              <input type="text" id="secondaryDns" name="secondaryDns"><br><br>
          
              <input type="button" value="Submit" onclick="submitForm()">
            </form>
          </div>

          <div class="device-table" id="device-table">
            <button id="addBtn">增加</button>
            <button id="deleteBtn">删除</button>
            <button id="editBtn">修改</button>
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAll" />全选</th>
                  <th>序号</th>
                  <th>设备名称</th>
                  <th>通道</th>
                  <th>规约</th>
                  <th>通信地址</th>
                  <th>类别</th>
                  <th>型号</th>
                  <th>SN</th>
                  <th>设备状态</th>
                </tr>
              </thead>
              <tbody id="deviceList">
              </tbody>
            </table>
          </div>

          <div class="channel-table" id="channel-table">
            <button id="channel-addBtn">增加</button>
            <button id="channel-deleteBtn">删除</button>
            <button id="channel-editBtn">修改</button>
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="channel-selectAll" />全选</th>
                  <th>序号</th>
                  <th>串口名</th>
                  <th>串口</th>
                  <th>波特率</th>
                  <th>数据位</th>
                  <th>停止位</th>
                  <th>校验位</th>
                </tr>
              </thead>
              <tbody id="channelList">
              </tbody>
            </table>
          </div>

          <div class="device-activity-table" id="device-activity-table">
            <table>
              <thead>
                <tr>
                  <th>序号</th>
                  <th>源名称</th>
                  <th>值</th>
                  <th>单位</th>
                </tr>
              </thead>
              <tbody id="deviceList">
              </tbody>
            </table>
          </div>

          <!-- 这里弹窗事件的内容 -->
          <div id="popupForm">
            <label for="deviceName">设备名称：</label>
            <input type="text" id="deviceName" placeholder="设备名称" />
            <!-- <input type="text" id="port" placeholder="通道" /> -->

            <label for="channel">通道: </label>
            <select id="channel" name="channel">
              <!-- 添加更多选项 -->
            </select><br><br>

            <label for="protocol">规约: </label>
            <select id="protocol" name="protocol">
              <option value="modbus">modbus</option>
              <!-- 添加更多选项 -->
            </select><br><br>

            <label for="communicationAddress">通信地址：</label>
            <input type="text" id="communicationAddress" placeholder="通信地址" />

            <label for="category">类别：</label>
            <select id="category" name="category">
              <option value="pcs">pcs</option>
              <option value="bms">bms</option>
              <!-- 添加更多选项 -->
            </select><br><br>

            <label for="model">型号：</label>
            <input type="text" id="model" placeholder="型号" />

            <label for="sn">SN：</label>
            <input type="text" id="sn" placeholder="SN" />

            <label for="deviceStatus">设备状态：</label>
            <input type="text" id="deviceStatus" placeholder="设备状态" />

            <button id="saveBtn">保存</button>
            <button id="cancelBtn">取消</button>
          </div>

          <div id="channel-form">
            <label for="portName">串口名：</label>
            <input type="text" id="portName" name="portName"><br><br>

            <label for="port">串口：</label>
            <select id="port" name="port">
              <option value="RS485-1">RS485-1</option>
              <option value="RS485-2">RS485-2</option>
              <option value="RS485-3">RS485-3</option>
              <option value="RS485-4">RS485-4</option>
              <option value="RS485-5">RS485-5</option>
              <option value="RS485-6">RS485-6</option>
              <option value="RS485-7">RS485-7</option>
              <option value="RS485-8">RS485-8</option>
              <!-- 添加更多选项 -->
            </select><br><br>

            <label for="baudRate">波特率：</label>
            <select id="baudRate" name="baudRate">
              <option value="9600">9600</option>
              <option value="19200">19200</option>
              <option value="38400">38400</option>
              <!-- 添加更多选项 -->
            </select><br><br>

            <label for="dataBits">数据位：</label>
            <select id="dataBits" name="dataBits">
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
            </select><br><br>
            
            <label for="stopBits">停止位：</label>
            <select id="stopBits" name="stopBits">
              <option value="1">1</option>
              <option value="1.5">1.5</option>
              <option value="2">2</option>
            </select><br><br>

            <label for="parity">校验位：</label>
            <select id="parity" name="parity">
              <option value="N">无校验</option>
              <option value="E">偶校验</option>
              <option value="O">奇校验</option>
            </select><br><br>

            <button id="channel-saveBtn">保存</button>
            <button id="channel-cancelBtn">取消</button>
          </div>
      </div>
    </main>
    <footer></footer>
  </div>
</body>
</html>